name: CI-CD

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up QEMU and Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push image
      uses: docker/build-push-action@v4
      with:
        push: true
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/flask-inventory:latest
        context: ./app

    - name: Scan image with Trivy
      uses: aquasecurity/trivy-action@v1
      with:
        image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/flask-inventory:latest

    - name: Update manifest repo (optional)
      env:
        GIT_AUTHOR_NAME: "github-actions"
        GIT_AUTHOR_EMAIL: "actions@github.com"
      run: |
        git config --global user.email "$GIT_AUTHOR_EMAIL"
        git config --global user.name "$GIT_AUTHOR_NAME"
        # If your manifests are in same repo, sed replace image tag
        sed -i "s|<DOCKERHUB_USERNAME>/flask-inventory:.*|${{ secrets.DOCKERHUB_USERNAME }}/flask-inventory:latest|" manifests/backend-deployment.yaml
        git add manifests/backend-deployment.yaml
        git commit -m "ci: update image to latest" || echo "no changes"
        git push origin HEAD:main || echo "push failed"
